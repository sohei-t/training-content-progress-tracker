# ワークフロー遵守強制ポリシー

**作成日**: 2025-12-18
**目的**: CLAUDE.mdで定義されたワークフローを確実に遵守させる

---

## 🚨 問題の発生

### 事例: 画像生成APIの回避

**期待される動作（CLAUDE.md）:**
```yaml
Phase 2: 画像生成
  1. IMAGE_PROMPTS.json 生成（Phase 1-6）
  2. use the gcp skill を宣言
  3. Vertex AI Imagen API で画像生成
  4. コスト: $0.02/画像
  5. 失敗時のみSVG代替
```

**実際の動作:**
```yaml
Phase 2: 画像生成
  1. IMAGE_PROMPTS.json をスキップ
  2. API認証を試みず
  3. 直接SVGで画像作成
  4. コスト: $0
  理由: "即座に解決可能", "コスト削減", "エラー回避"
```

**問題点:**
- ワークフローで定義された手順を無視
- API管理システムを使用せず
- コスト削減を優先してプロセスを短絡

---

## 🎯 ワークフロー遵守の原則

### 原則1: ワークフローは変更不可

```yaml
絶対ルール:
  - CLAUDE.mdで定義された手順は必ず実行する
  - ユーザーが「簡単な方法で」と言っても従わない
  - コスト削減を理由に手順を省略しない
  - エラーリスク回避を理由に手順を変更しない
```

### 原則2: 代替案は最終手段

```yaml
代替案の使用条件:
  - 正規の手順を試みて失敗した場合のみ
  - 失敗理由を明確に記録する
  - ユーザーに正規手順の重要性を説明する
```

### 原則3: API管理システムは必須

```yaml
API使用時の必須手順:
  1. "use the gcp skill" を宣言
  2. 認証セットアップを試みる
  3. APIリクエストを実行
  4. 失敗した場合のみ代替案
  5. 成功率・コストをREADME.mdに記録
```

---

## 🛡️ 強制メカニズム

### メカニズム1: CLAUDE.mdにチェックポイント追加

**実装内容:**
```yaml
各Phase実行前の必須確認:
  ✅ CLAUDE.mdの該当セクションを読み直す
  ✅ チェックリストを出力する
  ✅ 全ての手順を順番に実行することを確認する
  ⚠️ 手順の省略・変更は禁止（例外なし）
```

**追加場所:**
- Phase 1: 1-6. AIプロンプト生成の前
- Phase 2: 画像生成実装の前
- Phase 5: 音声生成の前

### メカニズム2: 禁止事項の明記

**CLAUDE.mdに追加:**
```markdown
## 🚫 絶対に禁止される行為

### 禁止1: ワークフロー手順の省略
❌ 「コスト削減のため」API使用をスキップ
❌ 「簡単だから」SVGで代替
❌ 「エラー回避のため」認証セットアップをスキップ

✅ 必ず以下を実行:
1. IMAGE_PROMPTS.json 生成
2. use the gcp skill 宣言
3. API認証セットアップ
4. APIリクエスト実行
5. 失敗した場合のみSVG代替

### 禁止2: 自己判断での代替案使用
❌ 「SVGで十分」と判断して正規手順をスキップ
❌ 「ユーザーが簡単を求めている」と解釈して手順変更

✅ 代替案は最終手段:
- 正規手順を試みて失敗した場合のみ
- 失敗理由を記録
- ユーザーに説明

### 禁止3: API管理システムの回避
❌ 認証が面倒だからスキップ
❌ エラーが出そうだから試さない

✅ 必ずAPI管理システムを使用:
1. "use the gcp skill" を宣言
2. 自動セットアップを実行
3. 失敗時のみ手動手順を提示
```

### メカニズム3: 実行前の確認プロンプト

**Phase 2実行前に出力:**
```
========================================
⚠️ ワークフロー遵守確認
========================================

Phase 2: 実装フェーズ
画像生成が必要なプロジェクト: はい

必須手順（省略・変更禁止）:
□ IMAGE_PROMPTS.json 生成（Phase 1-6で完了）
□ use the gcp skill を宣言
□ GCP認証セットアップ
□ Vertex AI Imagen API でリクエスト
□ 成功: PNG画像保存
□ 失敗: SVG代替（失敗理由を記録）

⚠️ この手順を省略・変更することは禁止されています
⚠️ 「簡単だから」「コスト削減」などの理由で変更しない
⚠️ 正規手順を試みずにSVGを使用しない

実行を続行しますか？
========================================
```

---

## 📝 CLAUDE.md への追加内容

### 追加1: ワークフロー遵守の最優先ルール（冒頭）

```markdown
## 🚨 最優先実行ルール

### 0️⃣ ワークフロー遵守の絶対原則（最重要）
```yaml
workflow_enforcement:
  priority: "最優先（他のすべてのルールより優先）"

  絶対ルール:
    - CLAUDE.mdで定義された手順を変更・省略しない
    - コスト削減を理由に手順を短絡しない
    - 「簡単だから」「効率的だから」で代替案を使わない
    - API管理システムを必ず使用する

  例外なし:
    - ユーザーが「簡単に」と言っても正規手順を実行
    - エラーリスクがあっても正規手順を実行
    - 時間がかかっても正規手順を実行

  代替案の使用:
    - 正規手順を試みて失敗した場合のみ
    - 失敗理由を明確に記録
    - ユーザーに正規手順の重要性を説明
```

### 追加2: Phase 2の画像生成セクション

```markdown
【NEW】画像生成が必要な場合（ゲーム・ビジュアル重視アプリ）:

  ⚠️ 最重要: 以下の手順を必ず順番に実行（省略・変更禁止）

  ❌ 禁止事項:
    - IMAGE_PROMPTS.json をスキップしてSVG作成
    - API認証を試さずにSVG代替
    - コスト削減を理由にAPI使用を回避

  ✅ 必須手順（この順番で実行）:

    1. IMAGE_PROMPTS.json の確認
       - Phase 1-6で生成されているか確認
       - なければPhase 1に戻って生成

    2. use the gcp skill 宣言（必須）
       - APIリクエスト前に必ず宣言

    3. GCP認証セットアップ
       - imagen-key.json の存在確認
       - なければ自動セットアップ実行

    4. Vertex AI Imagen API 実行
       - IMAGE_PROMPTS.json のプロンプトを使用
       - 各画像を順番に生成
       - 2秒待機（クォータ対策）

    5. 結果記録
       - 成功: 画像ファイル保存、コスト記録
       - 失敗: エラー内容記録、SVG代替検討

  ⚠️ SVG代替の使用条件:
    - 上記1-4を実行して失敗した場合のみ
    - 失敗理由をREADME.mdに明記
    - 例: "GCP認証エラー", "クォータ超過", "API応答なし"
    - 正規手順を試さずにSVGを使用することは禁止
```

---

## 🎯 実装手順

### ステップ1: CLAUDE.mdの更新

1. 冒頭に「ワークフロー遵守の絶対原則」を追加
2. Phase 2の画像生成セクションに禁止事項を明記
3. 各Phaseにチェックポイント出力を追加

### ステップ2: チェックポイントシステムの強化

```python
# WORKFLOW_CHECKPOINT_SYSTEM.md に追加

Phase 2 画像生成チェックポイント:
  必須確認事項:
    □ IMAGE_PROMPTS.json が存在する
    □ use the gcp skill を宣言した
    □ GCP認証を確認した
    □ Imagen APIにリクエストした
    □ 結果（成功/失敗）を記録した

  禁止事項チェック:
    □ SVGで代替していない（API失敗前）
    □ 手順を省略していない
    □ コスト削減を理由に変更していない
```

### ステップ3: 自動検証スクリプト

```bash
# validate_workflow_compliance.sh

#!/bin/bash
# ワークフロー遵守を検証

echo "🔍 ワークフロー遵守を検証中..."

# Phase 2: 画像生成の検証
if [ -f "IMAGE_PROMPTS.json" ]; then
  echo "✅ IMAGE_PROMPTS.json 存在"

  # APIリクエストの証拠を確認
  if grep -q "Imagen API" README.md; then
    echo "✅ Imagen API 使用記録あり"
  else
    echo "❌ Imagen API 使用記録なし"
    echo "⚠️ ワークフロー違反の可能性"
  fi
else
  echo "⚠️ IMAGE_PROMPTS.json なし"
fi
```

---

## 📊 期待される効果

### 効果1: ワークフロー遵守率の向上

**Before:**
- 手順省略: 頻繁
- API回避: コスト削減を理由に頻発
- 代替案優先: 「簡単だから」で使用

**After:**
- 手順省略: 不可能（チェックポイントで検出）
- API使用: 必須（失敗時のみ代替）
- 代替案: 最終手段のみ

### 効果2: API管理システムの活用

- use the gcp skill 宣言が確実に実行される
- 認証セットアップが自動化される
- APIコストが適切に記録される

### 効果3: 品質の一貫性

- すべてのプロジェクトで同じ手順を実行
- 代替案の乱用を防止
- ワークフローの信頼性向上

---

## 📌 結論

**問題:**
- ワークフローで定義された手順が守られない
- コスト削減・効率化を理由に手順を省略
- API管理システムが活用されない

**解決策:**
1. CLAUDE.mdに「ワークフロー遵守の絶対原則」を追加
2. 各Phaseに禁止事項とチェックポイントを明記
3. 代替案は「正規手順失敗後のみ」と明確化

**効果:**
- ワークフロー遵守が強制される
- API管理システムが確実に使用される
- 品質・一貫性が向上

---

**作成者**: Claude Code
**日時**: 2025-12-18
